<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Chatbot</title>
<style>
body {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background-color: #f0f2f5;
  display: flex;
  justify-content: center;
  align-items: center;
  height: 100vh;
  margin: 0;
  padding: 20px;
}

#container {
  background: white;
  border-radius: 15px;
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
  width: 100%;
  max-width: 1000px; 
  display: flex;
  flex-direction: column;
  overflow: hidden;
  height: 80vh; 
}

#chat {
  padding: 20px;
  height: calc(100% - 160px); /* Ajustado para el bot√≥n de exportaci√≥n */
  overflow-y: auto;
  background: #fff;
  flex-grow: 1;
  position: relative;
}

#user-input-container {
  display: flex;
  flex-direction: column;
  padding: 15px;
  background-color: #f0f2f5;
  border-top: 1px solid #e0e0e0;
}

#user-input {
  flex-grow: 1;
  padding: 12px 20px;
  border: none;
  border-radius: 20px;
  outline: none;
  font-size: 16px;
  background-color: white;
  box-shadow: 0 2px 5px rgba(0,0,0,0.1);
  margin-bottom: 10px;
  resize: vertical;
  min-height: 40px;
  max-height: 200px;
  transition: height 0.2s ease; 
}

#file-preview {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  margin-bottom: 10px;
  max-height: 150px;
  overflow-y: auto;
}

.file-item {
  background-color: #e4e6eb;
  padding: 5px;
  border-radius: 10px;
  font-size: 14px;
  display: flex;
  flex-direction: column;
  align-items: center;
  width: 100px;
  transform: scale(0.5); 
  opacity: 0;
  transition: transform 0.4s ease, opacity 0.4s ease;
}

.file-item.visible {
  transform: scale(1);
  opacity: 1;
}

.file-item img {
  width: 60px;
  height: 60px;
  object-fit: cover;
  border-radius: 5px;
  margin-bottom: 5px;
}

.file-item .file-name {
  text-align: center;
  word-break: break-word;
  max-width: 100%;
}

.file-item button {
  background: none;
  border: none;
  color: #65676b;
  cursor: pointer;
  margin-top: 5px;
  transition: color 0.3s ease;
}

.file-item button:hover {
  color: #ff0000;
}

#send-container {
  display: flex;
  align-items: center;
}

#file-upload {
  display: none;
}

#file-upload-label {
  background-color: #e4e6eb;
  color: #050505;
  padding: 10px;
  border-radius: 50%;
  cursor: pointer;
  margin-right: 10px;
  transition: background-color 0.3s ease;
}

#file-upload-label:hover {
  background-color: #d3d3d3;
}

#send-button {
  background-color: #0084ff;
  color: white;
  padding: 10px;
  border: none;
  border-radius: 50%;
  cursor: pointer;
  font-size: 16px;
  transition: background-color 0.3s ease;
}

#send-button:hover {
  background-color: #005bb5;
}

.message {
  margin: 10px 0;
  padding: 12px 18px;
  border-radius: 18px;
  max-width: 80%;
  font-size: 16px;
  line-height: 1.4;
  position: relative;
  clear: both;
  opacity: 0; 
  transform: translateY(20px); 
  transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out;
  word-break: break-all;
}

.message.visible {
  opacity: 1;
  transform: translateY(0);
}

.user {
  background: #0084ff;
  color: white;
  align-self: flex-end;
  float: right;
  margin-left: 20%;
  animation: userMessageIn 0.5s ease-out;
}

.bot {
  background: #e4e6eb;
  color: #050505;
  align-self: flex-start;
  float: left;
  margin-right: 20%;
  animation: botMessageIn 0.5s ease-out;
}

.bot code {
  background-color: #f1f1f1;
  padding: 2px 4px;
  border-radius: 4px;
  font-family: 'Courier New', Courier, monospace;
}

.bot pre {
  background-color: #f1f1f1;
  padding: 10px;
  border-radius: 4px;
  overflow: auto;
  font-family: 'Courier New', Courier, monospace;
}

h1 {
  text-align: center;
  margin: 20px 0;
  font-size: 28px;
  color: #333;
  font-weight: 600;
  animation: titleFadeIn 1s ease-out;
}

.file-attachments {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  margin-top: 10px;
}

/* Animaciones */
@keyframes userMessageIn {
  from {
    opacity: 0;
    transform: translateX(20px);
  }
  to {
    opacity: 1;
    transform: translateX(0);
  }
}

@keyframes botMessageIn {
  from {
    opacity: 0;
    transform: translateX(-20px);
  }
  to {
    opacity: 1;
    transform: translateX(0);
  }
}

@keyframes titleFadeIn {
  from {
    opacity: 0;
    transform: translateY(-20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

@keyframes sendButtonHover {
  from {
    transform: scale(1);
  }
  to {
    transform: scale(1.1);
  }
}

@keyframes fileUploadHover {
  from {
    transform: scale(1);
  }
  to {
    transform: scale(1.1);
  }
}

#send-button:hover {
  animation: sendButtonHover 0.1s ease-in-out;
}

#file-upload-label:hover {
  animation: fileUploadHover 0.1s ease-in-out;
}

/* Estilos para el estado de carga */
#loading-indicator {
  display: none;
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  z-index: 100;
  background-color: rgba(255, 255, 255, 0.8);
  padding: 20px;
  border-radius: 10px;
}

#loading-text {
  font-size: 18px;
  color: #333;
}

#loading-spinner {
  margin-top: 10px;
  width: 40px;
  height: 40px;
  border: 4px solid #0084ff;
  border-radius: 50%;
  border-top-color: transparent;
  animation: spin 1.2s linear infinite;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

/* Estilos para errores */
.error {
  color: #ff0000;
  font-weight: bold;
  margin-bottom: 10px;
}

/* Estilos para la copia del c√≥digo */
.copy-code {
  background-color: #0084ff;
  color: white;
  padding: 5px 10px;
  border: none;
  border-radius: 5px;
  cursor: pointer;
  margin-right: 5px;
  transition: background-color 0.3s ease;
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  font-size: 14px;
  display: inline-block;
}

.copy-code:hover {
  background-color: #005bb5;
}

/* Estilos para la copia de la respuesta */
.copy-response {
  background-color: #0084ff;
  color: white;
  padding: 5px 10px;
  border: none;
  border-radius: 5px;
  cursor: pointer;
  transition: background-color 0.3s ease;
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  font-size: 14px;
  display: inline-block;
}

.copy-response:hover {
  background-color: #005bb5;
}

/* Estilos para el bot√≥n de exportaci√≥n */
#export-button {
  background-color: #0084ff;
  color: white;
  padding: 10px 20px;
  border: none;
  border-radius: 5px;
  cursor: pointer;
  font-size: 16px;
  transition: background-color 0.3s ease;
  margin-top: 10px; /* Espacio entre el input y el bot√≥n */
}

#export-button:hover {
  background-color: #005bb5;
}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.6.0/styles/default.min.css">
</head>
<body>
<div id="container">
  <h1>Chatbot</h1>
  <div id="chat"></div>
  <div id="user-input-container">
    <div id="file-preview"></div>
    <div id="send-container">
      <textarea id="user-input" placeholder="Escribe tu mensaje..."></textarea>
      <label for="file-upload" id="file-upload-label">üìé</label>
      <input type="file" id="file-upload" multiple />
      <button id="send-button">‚û§</button>
    </div>
    <button id="export-button">Exportar a Markdown</button> </div>
  <div id="loading-indicator">
    <div id="loading-text">Procesando...</div>
    <div id="loading-spinner"></div>
  </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.6.0/highlight.min.js"></script>
<script>
const chatDiv = document.getElementById('chat');
const userInput = document.getElementById('user-input');
const fileUpload = document.getElementById('file-upload');
const filePreview = document.getElementById('file-preview');
const sendButton = document.getElementById('send-button');
const loadingIndicator = document.getElementById('loading-indicator');
const exportButton = document.getElementById('export-button');
let selectedFiles = [];

fileUpload.addEventListener('change', (event) => {
  const files = event.target.files;
  selectedFiles = Array.from(files);
  updateFilePreview();
});

function updateFilePreview() {
  filePreview.innerHTML = '';
  selectedFiles.forEach((file, index) => {
    const fileItem = document.createElement('div');
    fileItem.className = 'file-item visible'; 
    // Crear la previsualizaci√≥n
    if (file.type.startsWith('image/')) {
      const img = document.createElement('img');
      img.src = URL.createObjectURL(file);
      fileItem.appendChild(img);
    } else {
      const fileIcon = document.createElement('div');
      fileIcon.textContent = 'üìÑ';
      fileIcon.style.fontSize = '40px';
      fileItem.appendChild(fileIcon);
    }
    const fileName = document.createElement('div');
    fileName.className = 'file-name';
    fileName.textContent = file.name.length > 15 ? file.name.substring(0, 12) + '...' : file.name;
    fileItem.appendChild(fileName);
    const removeButton = document.createElement('button');
    removeButton.textContent = '√ó';
    removeButton.onclick = () => removeFile(index);
    fileItem.appendChild(removeButton);
    filePreview.appendChild(fileItem);
  });
}

function removeFile(index) {
  selectedFiles.splice(index, 1);
  updateFilePreview();
}

async function sendMessage() {
  const message = userInput.value.trim();
  if (!message && selectedFiles.length === 0) return;
  const formData = new FormData();
  formData.append('message', message);
  selectedFiles.forEach(file => {
    formData.append('files', file);
  });
  let displayMessage = message;
  addMessage(displayMessage, 'user');
  userInput.value = ''; // Limpiar el input
  userInput.style.height = 'auto'; // Restablecer la altura del input
  selectedFiles = [];
  updateFilePreview();
  showLoader();
  try {
    const response = await fetch('/chat', { method: 'POST', body: formData });
    const data = await response.json();
    if (data.error) {
      showError(data.error);
    } else {
      addMessage(data.message, 'bot');
    }
  } catch (error) {
    console.error('Error:', error);
    showError('Lo siento, hubo un error al procesar tu solicitud.');
  } finally {
    hideLoader();
  }
}

userInput.addEventListener('keydown', (event) => {
  if (event.key === 'Enter' && !event.shiftKey) {
    event.preventDefault();
    sendMessage();
  }
});

sendButton.addEventListener('click', sendMessage);

function addMessage(message, sender) {
  const msgDiv = document.createElement('div');
  msgDiv.classList.add('message', sender);
  msgDiv.classList.add('visible'); 

  if (sender === 'user' && selectedFiles.length > 0) {
    const fileAttachments = document.createElement('div');
    fileAttachments.className = 'file-attachments';
    selectedFiles.forEach(file => {
      const fileItem = document.createElement('div');
      fileItem.className = 'file-item visible';
      if (file.type.startsWith('image/')) {
        const img = document.createElement('img');
        img.src = URL.createObjectURL(file);
        fileItem.appendChild(img);
      } else {
        const fileIcon = document.createElement('div');
        fileIcon.textContent = 'üìÑ';
        fileIcon.style.fontSize = '40px';
        fileItem.appendChild(fileIcon);
      }
      const fileName = document.createElement('div');
      fileName.className = 'file-name';
      fileName.textContent = file.name.length > 15 ? file.name.substring(0, 12) + '...' : file.name;
      fileItem.appendChild(fileName);
      fileAttachments.appendChild(fileItem);
    });
    msgDiv.appendChild(fileAttachments);
  }

  const messageContent = document.createElement('div');
  messageContent.className = 'message-content';
  if (sender === 'bot') {
    messageContent.innerHTML = marked.parse(message);
    messageContent.querySelectorAll('pre code').forEach((block) => {
      hljs.highlightElement(block);
      // Crear bot√≥n de copiar c√≥digo
      const copyCodeButton = document.createElement('button');
      copyCodeButton.classList.add('copy-code');
      copyCodeButton.textContent = 'Copiar';
      copyCodeButton.addEventListener('click', () => {
        navigator.clipboard.writeText(block.textContent);
        // Puedes a√±adir un mensaje de confirmaci√≥n aqu√≠
        alert('C√≥digo copiado al portapapeles.');
      });
      block.parentNode.insertBefore(copyCodeButton, block.nextSibling);
    });
    // Crear bot√≥n de copiar respuesta
    const copyResponseButton = document.createElement('button');
    copyResponseButton.classList.add('copy-response');
    copyResponseButton.textContent = 'Copiar';
    copyResponseButton.addEventListener('click', () => {
      navigator.clipboard.writeText(msgDiv.textContent);
      alert('Respuesta copiada al portapapeles.');
    });
    msgDiv.appendChild(copyResponseButton);
  } else {
    messageContent.textContent = message;
  }
  msgDiv.appendChild(messageContent);
  chatDiv.appendChild(msgDiv);
  chatDiv.scrollTop = chatDiv.scrollHeight;
}

// Ajustar autom√°ticamente la altura del textarea
userInput.addEventListener('input', function() {
  this.style.height = 'auto';
  this.style.height = (this.scrollHeight) + 'px';
});

// Funciones para mostrar y ocultar el indicador de carga
function showLoader() {
  loadingIndicator.style.display = 'block';
}

function hideLoader() {
  loadingIndicator.style.display = 'none';
}

// Funci√≥n para mostrar errores
function showError(error) {
  const errorDiv = document.createElement('div');
  errorDiv.classList.add('error');
  errorDiv.textContent = error;
  chatDiv.appendChild(errorDiv);
  chatDiv.scrollTop = chatDiv.scrollHeight;
}

// Funci√≥n para exportar el historial a Markdown
exportButton.addEventListener('click', () => {
  const messages = chatDiv.querySelectorAll('.message');
  let markdown = '';
  messages.forEach(message => {
    const sender = message.classList.contains('user') ? 'T√∫' : 'Bot';
    const messageText = message.textContent.trim();
    // Formato para el mensaje 
    markdown += `\n---\n**${sender}:**\n${messageText.replace(/\n/g, '\n>')}\n---\n`; 
  });

  const blob = new Blob([markdown], { type: 'text/markdown' });
  const url = window.URL.createObjectURL(blob);
  const link = document.createElement('a');
  link.href = url;
  link.download = 'chat_history.md';
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
});
</script>
</body>
</html>
